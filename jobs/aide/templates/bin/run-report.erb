#!/bin/bash

set -x

JOB_DIR=/var/vcap/jobs/aide
PACKAGE_DIR=/var/vcap/packages/aide
LOGFILE=/var/vcap/sys/log/aide/report.log

# Source the calculate_changes function
source ${JOB_DIR}/bin/calculate-changes

source ${JOB_DIR}/bin/lock-functions

initialize_lock

flock -x -w 120 ${LOCKFD} -c "$PACKAGE_DIR/bin/aide --check" > report.txt
# aide exits nonzero when it finds a modification, so wait until here to set -e
set -e
date >> ${LOGFILE}
cat report.txt >> ${LOGFILE}
echo "=============================================" >> ${LOGFILE}

# report has lines like:
#           Added entries:     74
added=$(grep 'Added entries:' report.txt | awk '{ print $3 }')
if [[ -z "${added}" ]]; then
    added=0
fi
removed=$(grep 'Removed entries:' report.txt | awk '{ print $3 }')
if [[ -z "${removed}" ]]; then
    removed=0
fi

# Call the calculate_changes function
changed=$(calculate_changes "$LOGFILE")

# Add what was reported to Prometheus to the logs
echo 'aide_violation_count {action="added"}' ${added} >> ${LOGFILE}
echo 'aide_violation_count {action="removed"}' ${removed} >> ${LOGFILE}
echo 'aide_violation_count {action="changed"}' ${changed} >> ${LOGFILE}

# Write out the aide.prom file which is read by node-exporter
echo 'aide_violation_count {action="added"}' ${added} > aide.prom
echo 'aide_violation_count {action="removed"}' ${removed} >> aide.prom
echo 'aide_violation_count {action="changed"}' ${changed} >> aide.prom

mv aide.prom /var/vcap/jobs/node_exporter/config/aide.prom

rm report.txt

touch /var/vcap/data/aide/report-ran