#!/bin/bash

LOCKFILE="/var/vcap/sys/run/aide/update.lock"
LOCKFD=99

release_locks() {
  flock -u ${LOCKFD}
  flock -xn ${LOCKFD} && rm -f ${LOCKFILE}
}

initialize_lock() {
  exec ${LOCKFD}<>${LOCKFILE}
  trap release_locks EXIT
}

update_aide() {
  aide --update
  mv /var/vcap/store/aide/conf/aide.db.new /var/vcap/store/aide/conf/aide.db
}

initialize_locks

flock -x -w 120 ${LOCKFD} -c update_aide

